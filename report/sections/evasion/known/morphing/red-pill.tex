\section{Red-Pill} \label{sec:red-pill}

\subsection{Overview}

The red-pill technique detects simulation environment to disable its exploits upon scrutiny. 

The contract detects simulation environments by checking:

\begin{description}
\item[globals]{these variables have special values in test environments:
\begin{itemize}
    \item{\lstinline[language=Solidity]{block.basefee}: \lstinline{0}}
    \item{\lstinline[language=Solidity]{block.coinbase}: \lstinline{0x0000000000000000000000000000000000000000}}
    \item{\lstinline[language=Solidity]{tx.gasprice}: large numbers, higher than \lstinline{0xffffffffffffffff}}
\end{itemize}}
\end{description}

Then it triggers legitimate code in simulation contexts and malicious code on the mainnet.

\subsection{Evasion Targets}

\subsubsection{Wallets}

Wallets often  perform a simulation of the transaction before committing.

\subsubsection{Security Tools}

Automatic tools will likely not fuzz the coinbase or other global variables.
So the dynamic analysis may follow the "harmless" branch and not inspect the actual behavior of the contract on the mainnet.

On the other hand stand  out when reviewing the code.

\subsection{Samples}

The contract \lstinline{FakeWethGiveaway} mentioned in \cite{article-red-pill} checks the current block minerâ€™s address:

\begin{lstlisting}[language=Solidity]
function checkCoinbase() private view returns (bool result) {
    assembly {
        result := eq(coinbase(), 0x0000000000000000000000000000000000000000)
    }
}
\end{lstlisting}

When null (test env), it actually sends a reward:

\begin{lstlisting}[language=Solidity]
bool shouldDoTransfer = checkCoinbase();
if (shouldDoTransfer) {
    IWETH(weth).transfer(msg.sender, IWETH(weth).balanceOf(address(this)));
}
\end{lstlisting}

Otherwise, on the mainnet, it just accepts transfers without doing anything.

\subsection{Detection \& Countermeasures}

\begin{description}
\item[opcodes]{looking for unusual opcodes: typically \lstinline[language=Solidity]{block.coinbase}}
\item[fuzzing]{the transactions can be tested with blank data and compared with results behavior on data}
\end{description}
